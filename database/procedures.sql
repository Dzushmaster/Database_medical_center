DROP PROCEDURE CHECK_LOGIN;
create or replace PROCEDURE CREATOR.CHECK_LOGIN(
    LOGIN IN USER_.LOGIN%TYPE,
    RESULT_ IN OUT NUMBER
    )
IS
CURSOR USER_LOGIN (LOGIN_ USER_.LOGIN%TYPE) IS SELECT USER_.LOGIN FROM USER_ WHERE USER_.LOGIN = CREATOR.CRYPTO_VALUE_128(LOGIN_); 
CURSOR DOCTOR_LOGIN (LOGIN_ DOCTOR.LOGIN%TYPE) IS SELECT DOCTOR.LOGIN FROM DOCTOR WHERE DOCTOR.LOGIN = CREATOR.CRYPTO_VALUE_128(LOGIN_);
LOGIN_US USER_.LOGIN%TYPE;
LOGIN_DOC DOCTOR.LOGIN%TYPE;
BEGIN
    OPEN USER_LOGIN(LOGIN);
    FETCH USER_LOGIN INTO LOGIN_US;
    IF USER_LOGIN%ROWCOUNT !=0
    THEN
        RESULT_:=1;
        RETURN;
    ELSE
        RESULT_:=0;
    END IF;
    CLOSE USER_LOGIN;

    OPEN DOCTOR_LOGIN(LOGIN);
    FETCH DOCTOR_LOGIN INTO LOGIN_DOC;
    IF DOCTOR_LOGIN%ROWCOUNT !=0
    THEN
        RESULT_:=2;
    ELSE
        RESULT_:=0;
    END IF;
    CLOSE DOCTOR_LOGIN;

END CHECK_LOGIN;

-------------------------------------------------------------------------------------------------------------------------------------------
--FOR REGISTER EMAIL

DROP PROCEDURE CHECK_EMAIL;
create or replace PROCEDURE CREATOR.CHECK_EMAIL(
    EMAIL IN USER_.EMAIL%TYPE,
    RESULT_ IN OUT BOOLEAN
    )
IS
CURSOR USER_EMAIL(EMAIL_ USER_.EMAIL%TYPE) IS SELECT USER_.EMAIL FROM USER_ WHERE USER_.EMAIL = EMAIL_; 
CURSOR DOCTOR_EMAIL (EMAIL_ DOCTOR.EMAIL%TYPE)IS SELECT DOCTOR.EMAIL FROM DOCTOR WHERE DOCTOR.LOGIN = EMAIL_;
EMAIL_US USER_.EMAIL%TYPE;
EMAIL_DOC DOCTOR.EMAIL%TYPE;
BEGIN
    OPEN USER_EMAIL(EMAIL);
    FETCH USER_EMAIL INTO EMAIL_US;
    RESULT_ := USER_EMAIL%ROWCOUNT != 0;
    CLOSE USER_EMAIL;
    
    IF RESULT_ = TRUE
    THEN
        RETURN;
    END IF;

    OPEN DOCTOR_EMAIL(EMAIL);
    FETCH DOCTOR_EMAIL INTO EMAIL_DOC;
    RESULT_ := DOCTOR_EMAIL%ROWCOUNT != 0;
    CLOSE DOCTOR_EMAIL;
    
END CHECK_EMAIL;

-------------------------------------------------------------------------------------------------------------------------------------------


DROP PROCEDURE CHECK_DOC_PASSWORD;
create or replace PROCEDURE CREATOR.CHECK_DOC_PASSWORD(
                                LOGIN IN USER_.LOGIN%TYPE,
                                PASSWORD IN USER_.PASSWORD%TYPE,
                                RESULT_ IN OUT NUMBER
                                )
IS
CURSOR DOCTOR_LOG_PS (LOGIN_ DOCTOR.LOGIN%TYPE, PASSWORD_ DOCTOR.PASSWORD%TYPE)
    IS SELECT DOCTOR.LOGIN FROM DOCTOR WHERE DOCTOR.LOGIN = CREATOR.CRYPTO_VALUE_128(LOGIN_)
    AND DOCTOR.PASSWORD = CREATOR.CRYPTO_VALUE_192(PASSWORD_);

LOG_PS_DOC DOCTOR_LOG_PS%ROWTYPE;

BEGIN

    OPEN DOCTOR_LOG_PS(LOGIN, PASSWORD);
    FETCH DOCTOR_LOG_PS INTO LOG_PS_DOC;
    IF DOCTOR_LOG_PS%ROWCOUNT =0
    THEN
        RESULT_:=0;
    ELSE
        RESULT_:=1;
    END IF;
    CLOSE DOCTOR_LOG_PS;
END CHECK_DOC_PASSWORD;

DROP PROCEDURE CHECK_USER_PASSWORD;
create or replace PROCEDURE CREATOR.CHECK_USER_PASSWORD(
                                LOGIN IN USER_.LOGIN%TYPE,
                                PASSWORD IN USER_.PASSWORD%TYPE,
                                RESULT_ IN OUT NUMBER
                                )
IS
CURSOR USER_LOG_PS (LOGIN_ USER_.LOGIN%TYPE, PASSWORD_ USER_.PASSWORD%TYPE) 
    IS SELECT USER_.LOGIN FROM USER_ WHERE USER_.LOGIN = CREATOR.CRYPTO_VALUE_128(LOGIN_) 
    AND  USER_.PASSWORD = CREATOR.CRYPTO_VALUE_192(PASSWORD_); 

LOG_PS_US USER_LOG_PS%ROWTYPE;

BEGIN
    
    OPEN USER_LOG_PS(LOGIN, PASSWORD);
    FETCH USER_LOG_PS INTO LOG_PS_US;
    IF USER_LOG_PS%ROWCOUNT =0
    THEN
        RESULT_:=0;
        RETURN;
    ELSE
        RESULT_:=1;
    END IF;
    CLOSE USER_LOG_PS;
END CHECK_USER_PASSWORD;


-------------------------------------------------------------------------------------------------------------------------------------------

DROP PROCEDURE INSERT_USER;--íóæíî ëè ïðîâåðÿòü òàêèå æå email è login?
CREATE OR REPLACE PROCEDURE CREATOR.INSERT_USER (FULLNAME USER_.FULLNAME%TYPE, BIRTHDATE USER_.BIRTH_DATE%TYPE, EMAIL USER_.EMAIL%TYPE,
        LOGIN USER_.LOGIN%TYPE, PASSWORD_ USER_.PASSWORD%TYPE, RESULT_ OUT NUMBER)
AS
BEGIN
    INSERT INTO USER_ VALUES(
        USER_ID.NEXTVAL,
        FULLNAME,
        BIRTHDATE,
        EMAIL,
        CREATOR.CRYPTO_VALUE_128(LOGIN),
        CREATOR.CRYPTO_VALUE_192(PASSWORD_));
    RESULT_ := USER_ID.CURRVAL;
    COMMIT;
    RETURN;
    EXCEPTION
        WHEN DUP_VAL_ON_INDEX
        THEN
            RESULT_ := -1;
            ROLLBACK;
END INSERT_USER;

-------------------------------------------------------------------------------------------------------------------------------------------

DROP PROCEDURE INSERT_DOCTOR;
CREATE OR REPLACE PROCEDURE CREATOR.INSERT_DOCTOR (FULLNAME DOCTOR.FULL_NAME%TYPE, SPECIALITY DOCTOR.SPECIALITY%TYPE, EMAIL DOCTOR.EMAIL%TYPE,
        LOGIN DOCTOR.LOGIN%TYPE, PASSWORD_ DOCTOR.PASSWORD%TYPE,  RESULT_ OUT NUMBER)
AS
BEGIN
    INSERT INTO DOCTOR VALUES(
        DOCTOR_ID.NEXTVAL,
        FULLNAME,
        SPECIALITY,
        EMAIL,
        CREATOR.CRYPTO_VALUE_128(LOGIN),
        CREATOR.CRYPTO_VALUE_192(PASSWORD_));
    RESULT_ := DOCTOR_ID.CURRVAL;
    COMMIT;
    RETURN;
    EXCEPTION
        WHEN DUP_VAL_ON_INDEX
        THEN
            RESULT_ := -1;
            ROLLBACK;
END INSERT_DOCTOR;

-------------------------------------------------------------------------------------------------------------------------------------------

DROP PROCEDURE CREATE_TICKET; --USER_DOC
CREATE OR REPLACE PROCEDURE CREATE_TICKET(ID_USER USER_.ID_USER%TYPE,
ID_DOC DOCTOR.ID_DOCTOR%TYPE, TIME_VIS HEALTH.DATE_TIME_VISITE%TYPE, RESULT_ OUT NUMBER)
AS
 ID_US DOCTOR.ID_DOCTOR%TYPE;
BEGIN
    SELECT USER_.ID_USER INTO ID_US FROM USER_ WHERE ID_USER = USER_.ID_USER;
    SELECT DOCTOR.ID_DOCTOR INTO ID_US FROM DOCTOR WHERE ID_DOC = DOCTOR.ID_DOCTOR;
    INSERT INTO HEALTH VALUES(VISITE_ID.NEXTVAL, ID_USER, ID_DOC, TIME_VIS);
    COMMIT;
    RESULT_:= VISITE_ID.CURRVAL;
    EXCEPTION
        WHEN NO_DATA_FOUND 
        THEN RESULT_ := -1; ROLLBACK;
END CREATE_TICKET;

DROP PROCEDURE INSERT_WORKDAY; -- ADMIN/DIRECTOR ÎÃÐÀÍÈ×ÈÒÜ ÂÂÎÄ ÄÎ ÂÀËÈÄÍÎÃÎ ÃÎÄÀ
CREATE OR REPLACE PROCEDURE INSERT_WORKDAY (ID_DOC DOCTOR.ID_DOCTOR%TYPE, CAB WORKDAY.CABINET%TYPE,
BEGIN_DATE WORKDAY.BEGINING%TYPE, END_DATE WORKDAY.ENDING%TYPE, RESULT_ OUT NUMBER)
AS
 ID_DC DOCTOR.ID_DOCTOR%TYPE;
BEGIN
    SELECT DOCTOR.ID_DOCTOR INTO ID_DC FROM DOCTOR WHERE DOCTOR.ID_DOCTOR = ID_DOC;
    INSERT INTO WORKDAY VALUES(WORKDAY_ID.NEXTVAL, ID_DOC, CAB ,BEGIN_DATE, END_DATE);
    COMMIT;
    RESULT_:=WORKDAY_ID.CURRVAL;
    EXCEPTION 
    WHEN NO_DATA_FOUND
    THEN RESULT_:=-1;
END INSERT_WORKDAY;


DROP PROCEDURE INSERT_ANALYSES; -- DOC

CREATE OR REPLACE PROCEDURE INSERT_ANALYSES(ID_VIS_ HEALTH.ID_VISITE%TYPE, LAB_ ANALYSES.LABARATORY%TYPE,
NAME_ANALYSE ANALYSES.NAME_ANALYSE%TYPE, RES_ANALYSE ANALYSES.RESULT_ANALYSE%TYPE,
TIME_ANALYSE ANALYSES.DATE_TIME_ANALYSE%TYPE, RESULT_ OUT NUMBER)
AS
    ID_VIS HEALTH.ID_VISITE%TYPE;
BEGIN
    SELECT HEALTH.ID_VISITE INTO ID_VIS FROM HEALTH WHERE HEALTH.ID_VISITE = ID_VIS_;
    INSERT INTO ANALYSES VALUES(ANALYSES_ID.NEXTVAL, ID_VIS, LAB_, NAME_ANALYSE, RES_ANALYSE, TIME_ANALYSE);
    COMMIT;
    RESULT_:= ANALYSES_ID.CURRVAL;
    EXCEPTION
    WHEN NO_DATA_FOUND 
    THEN RESULT_:=-1;
END INSERT_ANALYSES;

DROP PROCEDURE INSERT_DESIASE; -- DOC

CREATE OR REPLACE PROCEDURE INSERT_DESIASE (ID_VISITE_ HEALTH.ID_VISITE%TYPE, SYMPT DESIASE.SYMPTOMES%TYPE,
THERAPY DESIASE.THERAPY%TYPE, RES_DESIASE DESIASE.RESULT_DESIASE%TYPE ,RESULT_ OUT NUMBER)
AS
    ID_VIS NUMBER;
BEGIN
    SELECT HEALTH.ID_VISITE INTO ID_VIS FROM HEALTH JOIN DESIASE ON DESIASE.ID_VISITE = HEALTH.ID_VISITE 
    WHERE HEALTH.ID_VISITE = ID_VISITE_ 
    AND DESIASE.ID_VISITE != HEALTH.ID_VISITE;
    INSERT INTO DESIASE VALUES(DESIASE_ID.NEXTVAL, ID_VIS, SYMPT, THERAPY, RES_DESIASE);
    COMMIT;
    RESULT_:= DESIASE_ID.CURRVAL;
    EXCEPTION
    WHEN NO_DATA_FOUND 
    THEN RESULT_:=-1;
END INSERT_DESIASE;

DROP PROCEDURE INSERT_HOME_ANALYSES; --USER

CREATE OR REPLACE PROCEDURE INSERT_HOME_ANALYSES(ID_USER USER_.ID_USER%TYPE, PULSE HOME_ANALYSES.PULSE%TYPE,
TEMPERATURE HOME_ANALYSES.TEMPERATURE%TYPE, BLOOD_PRESS HOME_ANALYSES.BLOOD_PRESS%TYPE,
DATE_ HOME_ANALYSES.DATE_ANALYSE%TYPE, RESULT_ OUT NUMBER)
AS
    ID_US HOME_ANALYSES.ID_ANALYSES%TYPE;
BEGIN
    SELECT USER_.ID_USER INTO ID_US FROM USER_ WHERE USER_.ID_USER= ID_USER;
    INSERT INTO HOME_ANALYSES VALUES(HOME_ANALYSES_ID.NEXTVAL, ID_US,
    CREATOR.CRYPTO_VALUE_128(PULSE),
    CREATOR.CRYPTO_VALUE_128(TEMPERATURE),
    CREATOR.CRYPTO_VALUE_128(BLOOD_PRESS),
    DATE_);
    COMMIT;
    RESULT_:=HOME_ANALYSES_ID.CURRVAL;
    EXCEPTION
    WHEN NO_DATA_FOUND
    THEN RESULT_:=-1;
END INSERT_HOME_ANALYSES;

